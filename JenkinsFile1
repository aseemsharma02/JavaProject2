pipeline {
    agent any
    tools {
       maven 'M2_HOME'
    }
    environment {
    registry = '467864354237.dkr.ecr.us-east-1.amazonaws.com/dockerimage'
    registryCredentials = 'Jenkins-ECR-login-credential'
    dockerImage = ''
    }
    stages {
        stage('Hello') {
            steps {
                echo 'Hello World'
                echo 'Hiya World Now'
            }
        }
        stage ('checkout') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/aseemsharma02/JavaProject2.git']]])
            }
        }
        stage('Build') {
            steps {
                sh 'mvn clean package'
                }
        }
    ////   stage('SonarQube') {
        //    steps {
        //  script{
        //    withSonarQubeEnv(installationName: 'SonarScannerAWS', credentialsId: 'AWS_Sonar_Server_Token') {
        //    sh 'mvn sonar:sonar'
        //    //sh 'mvn verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -Dsonar.projectKey=JavaProject-2'
        //    }
        //    waitForQualityGate abortPipeline: false, credentialsId: 'AWS_Sonar_Server_Token'
        //          }
        //          }
        //  }
        //   stage('Quality Gate'){
        //   steps {
        //   script {
        //  timeout(time: 1, unit: 'HOURS') {
        //      def qg = waitForQualityGate()
        //      if (qg.status != 'OK') {
        //          error "Pipeline aborted due to quality gate failure: ${qg.status}"
        //      }
        //    }
        //   }
        //   }
        //  }         
            stage ('Building Docker Image') {
            steps {
            script {
            dockerImage = docker.build registry + ":$BUILD_NUMBER"
                        }
                    }
                }
            stage ('Deploy the image to AWS ECR'){
            steps {
            script {
            docker.withRegistry("https://" + registry, "ecr:us-east-1:" + registryCredentials) {
            dockerImage.push()
                        }
                    }
                  }
               }
            }
           post {
               success {
                     slackSend( channel: "#jenkins-feedback", token: "Slack-Token", color: "green", message: "Build successful")
                 }     }
            post {
                failure {
                        slackSend( channel: "#jenkins-feedback", token: "Slack-Token", color: "red", message: "Build failed")
                       }  
               }
  }
